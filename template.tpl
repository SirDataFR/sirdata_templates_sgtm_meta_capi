___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "sirdata_templates_sgtm_meta_capi",
  "version": 1.4,
  "securityGroups": [],
  "displayName": "GDPR Ready Meta/Facebook CAPI by Sirdata",
  "categories": [
    "ADVERTISING",
    "ATTRIBUTION",
    "CONVERSIONS",
    "MARKETING",
    "REMARKETING",
    "SOCIAL"
  ],
  "brand": {
    "id": "sirdata",
    "displayName": "Sirdata",
    "thumbnail": "data:image/jpeg;base64,/9j/4QC8RXhpZgAASUkqAAgAAAAGABIBAwABAAAAAQAAABoBBQABAAAAVgAAABsBBQABAAAAXgAAACgBAwABAAAAAgAAABMCAwABAAAAAQAAAGmHBAABAAAAZgAAAAAAAABgAAAAAQAAAGAAAAABAAAABgAAkAcABAAAADAyMTABkQcABAAAAAECAwAAoAcABAAAADAxMDABoAMAAQAAAP//AAACoAQAAQAAAPAAAAADoAQAAQAAALQAAAAAAAAA/+EN8mh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8APD94cGFja2V0IGJlZ2luPSfvu78nIGlkPSdXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQnPz4KPHg6eG1wbWV0YSB4bWxuczp4PSdhZG9iZTpuczptZXRhLyc+CjxyZGY6UkRGIHhtbG5zOnJkZj0naHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyc+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczpBdHRyaWI9J2h0dHA6Ly9ucy5hdHRyaWJ1dGlvbi5jb20vYWRzLzEuMC8nPgogIDxBdHRyaWI6QWRzPgogICA8cmRmOlNlcT4KICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0nUmVzb3VyY2UnPgogICAgIDxBdHRyaWI6Q3JlYXRlZD4yMDIxLTExLTA3PC9BdHRyaWI6Q3JlYXRlZD4KICAgICA8QXR0cmliOkV4dElkPmYzNThjNTcyLWM4ZTAtNGRjZC1iYmQzLTcyMWU5OTZmNmJmMDwvQXR0cmliOkV4dElkPgogICAgIDxBdHRyaWI6RmJJZD41MjUyNjU5MTQxNzk1ODA8L0F0dHJpYjpGYklkPgogICAgIDxBdHRyaWI6VG91Y2hUeXBlPjI8L0F0dHJpYjpUb3VjaFR5cGU+CiAgICA8L3JkZjpsaT4KICAgPC9yZGY6U2VxPgogIDwvQXR0cmliOkFkcz4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PScnCiAgeG1sbnM6ZGM9J2h0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvJz4KICA8ZGM6dGl0bGU+CiAgIDxyZGY6QWx0PgogICAgPHJkZjpsaSB4bWw6bGFuZz0neC1kZWZhdWx0Jz5sb2dvIG1ldGEgbWluaTwvcmRmOmxpPgogICA8L3JkZjpBbHQ+CiAgPC9kYzp0aXRsZT4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PScnCiAgeG1sbnM6cGRmPSdodHRwOi8vbnMuYWRvYmUuY29tL3BkZi8xLjMvJz4KICA8cGRmOkF1dGhvcj5waWVycmVhbGFpbmJhbHk8L3BkZjpBdXRob3I+CiA8L3JkZjpEZXNjcmlwdGlvbj4KCiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0nJwogIHhtbG5zOnhtcD0naHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyc+CiAgPHhtcDpDcmVhdG9yVG9vbD5DYW52YTwveG1wOkNyZWF0b3JUb29sPgogPC9yZGY6RGVzY3JpcHRpb24+CjwvcmRmOlJERj4KPC94OnhtcG1ldGE+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg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BRitqGIq4eXPSlZmNfD08RHlqRuj521b4T+I7NmNolvfRjoYpNrfk2P51hSeCPE0bYbRL3PsgP8AI19TYFGB6V7dPiXFxVpJM8apw7hpO8W0fL1t4B8UXLAJo1wvvIVQfqa63Qvg7fzsr61exW0feOD53/M8D9a90wPQUYqK3EeMqK0bR9P+CXR4fwtN3leXqYvhrwzpfh228nS7ZYyfvyt8zv8AVv8AIraxRRXhznKpLmm7s9mFONOPLBWQUUUVJYUUUUAFFFFABRRRQAUUUUABqlqul2Wq2b2upW8dzbv1SQZH19j71doppuLutxOKkrM8Z8RfBeN5Hl8P33lA8iC5ywHsGHP5g1w198NPFdm5H9mGdR/FBIrg/qD+lfT+KMD0r2sPn+LorlbUl5nk1skw1V3St6Hyl/whPictj+w7/wD791qab8MPFN64DWC2qHq9xKox+Aya+mcCjA9K3nxNimrRil9/+Zzx4ew6esmzyrwv8IbCykSbXLg38g58lBtiz792/SvUbeCK3iSKBFjiQYVFGAB6AVJiivGxOLrYqXNWlc9bD4Slhly0o2CiiiuY6QooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//2Q\u003d\u003d"
  },
  "description": "Send GA4 data to Meta/Facebook CAPI with built-in consent controls. Works on any GTM Server (GCP, Stape, Sirdata, etc.). Optimized for Sirdata’s enrichment layer, which also works on any GTM Server.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "eventName",
    "displayName": "Event Name Setup Method",
    "selectItems": [
      {
        "value": "inherit",
        "displayValue": "Inherit from GA4 (default)"
      },
      {
        "value": "custom",
        "displayValue": "Set custom event name"
      },
      {
        "value": "AddPaymentInfo",
        "displayValue": "AddPaymentInfo"
      },
      {
        "value": "AddToCart",
        "displayValue": "AddToCart"
      },
      {
        "value": "AddToWishlist",
        "displayValue": "AddToWishlist"
      },
      {
        "value": "CompleteRegistration",
        "displayValue": "CompleteRegistration"
      },
      {
        "value": "Contact",
        "displayValue": "Contact"
      },
      {
        "value": "CustomizeProduct",
        "displayValue": "CustomizeProduct"
      },
      {
        "value": "Donate",
        "displayValue": "Donate"
      },
      {
        "value": "FindLocation",
        "displayValue": "FindLocation"
      },
      {
        "value": "InitiateCheckout",
        "displayValue": "InitiateCheckout"
      },
      {
        "value": "Lead",
        "displayValue": "Lead"
      },
      {
        "value": "PageView",
        "displayValue": "PageView"
      },
      {
        "value": "Purchase",
        "displayValue": "Purchase"
      },
      {
        "value": "Schedule",
        "displayValue": "Schedule"
      },
      {
        "value": "Search",
        "displayValue": "Search"
      },
      {
        "value": "StartTrial",
        "displayValue": "StartTrial"
      },
      {
        "value": "SubmitApplication",
        "displayValue": "SubmitApplication"
      },
      {
        "value": "Subscribe",
        "displayValue": "Subscribe"
      },
      {
        "value": "ViewContent",
        "displayValue": "ViewContent"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "inherit",
    "subParams": [
      {
        "type": "TEXT",
        "name": "customEventName",
        "displayName": "custom event name",
        "simpleValueType": true,
        "alwaysInSummary": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "eventName",
            "paramValue": "custom",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "accessToken",
    "displayName": "API Access Token",
    "simpleValueType": true,
    "help": "Mandatory. Get your API Access Token from your Meta/Facebook account. See \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/server-side-api/get-started#access-token\" target\u003d\"_blank\"\u003ehere\u003c/a\u003e for more information.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "pixelId",
    "displayName": "Meta/Facebook Pixel ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Mandatory. Set a single Facebook Pixel ID."
  },
  {
    "type": "TEXT",
    "name": "testId",
    "displayName": "Test ID",
    "simpleValueType": true,
    "help": "For the\"Test Events\" feature of Meta/Facebook Events Manager.",
    "valueHint": "TEST_ID"
  },
  {
    "type": "CHECKBOX",
    "name": "generateFbpCookie",
    "checkboxText": "Generate \"_fbp\" and \"_fbc\" cookies if consent is given.",
    "simpleValueType": true,
    "help": "For more information please refer to this \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/conversions-api/parameters/fbp-and-fbc/\" target\u003d\"_blank\"\u003edocumentation\u003c/a\u003e.",
    "defaultValue": true,
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "forwardUserData",
    "checkboxText": "Automatically forward user_data to Meta (e.g. hashed name, hashed email etc.)",
    "simpleValueType": true,
    "help": "For more information please refer to this \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/conversions-api/parameters/fbp-and-fbc/\" target\u003d\"_blank\"\u003edocumentation\u003c/a\u003e.",
    "defaultValue": true,
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "forwardIdentifiers",
    "checkboxText": "Automatically forward identification data to Meta (e.g. user_id, IP address, localisation, user-agent etc.) for higher Event Match Quality",
    "simpleValueType": true,
    "help": "For more information please refer to this \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/conversions-api/integration-quality-api//\" target\u003d\"_blank\"\u003edocumentation\u003c/a\u003e.",
    "defaultValue": true,
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "sendPixelFromBrowser",
    "checkboxText": "Send pixel request if consent is given",
    "simpleValueType": true,
    "help": "Send a pixel request back to the browser if consent is given. Don\u0027t forget to remove the Facebook SDK if you activate this option.",
    "defaultValue": true,
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "sendWithoutConsent",
    "checkboxText": "Send data without consent using a random fbp ID or cookieless user ID",
    "simpleValueType": true,
    "help": "To use the cookieless user ID, the client must subscribe to the \"site-only cookieless user ID\" option offered by \u003ca href\u003d\"https://sgtm.sirdata.io\" target\u003d\"_blank\"\u003eSirdata\u003c/a\u003e, which doesn\u0027t allow tracking accross websites.",
    "alwaysInSummary": true
  },
  {
    "displayName": "Server Event Data Override",
    "name": "serverEventGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "name": "serverEvent",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "event_id",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "action_source",
                "displayValue": "Action Source"
              },
              {
                "value": "data_processing_options",
                "displayValue": "Data Processing Options"
              },
              {
                "value": "data_processing_options_country",
                "displayValue": "Data Processing Options Country"
              },
              {
                "value": "data_processing_options_state",
                "displayValue": "Data Processing Options State"
              },
              {
                "value": "event_id",
                "displayValue": "Event ID"
              },
              {
                "value": "event_time",
                "displayValue": "Event Time"
              },
              {
                "value": "opt_out",
                "displayValue": "Opt Out"
              },
              {
                "value": "event_source_url",
                "displayValue": "Source URL"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ],
    "help": "For more information on the data parameters you can override, please refer to this \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/conversions-api/parameters/server-event\" target\u003d\"_blank\"\u003edocumentation\u003c/a\u003e."
  },
  {
    "displayName": "User Data",
    "name": "userDataGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "name": "userData",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "em",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "fbp",
                "displayValue": "Browser ID"
              },
              {
                "value": "ct",
                "displayValue": "City"
              },
              {
                "value": "client_ip_address",
                "displayValue": "Client IP address"
              },
              {
                "value": "client_user_agent",
                "displayValue": "Client user agent"
              },
              {
                "value": "fbc",
                "displayValue": "Click ID"
              },
              {
                "value": "country",
                "displayValue": "Country"
              },
              {
                "value": "db",
                "displayValue": "Date of Birth"
              },
              {
                "value": "email",
                "displayValue": "Email"
              },
              {
                "value": "em",
                "displayValue": "Email (sha-256)"
              },
              {
                "value": "external_id",
                "displayValue": "External ID"
              },
              {
                "value": "fb_login_id",
                "displayValue": "FB Login ID"
              },
              {
                "value": "fn",
                "displayValue": "First Name"
              },
              {
                "value": "ge",
                "displayValue": "Gender"
              },
              {
                "value": "ln",
                "displayValue": "Last Name"
              },
              {
                "value": "lead_id",
                "displayValue": "Lead ID"
              },
              {
                "value": "ph",
                "displayValue": "Phone"
              },
              {
                "value": "st",
                "displayValue": "State"
              },
              {
                "value": "subscription_id",
                "displayValue": "Subscription ID"
              },
              {
                "value": "zp",
                "displayValue": "Zip"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ],
    "help": "Please refer to this Refer to this documentation for more information on the user data parameters you can include in the request. The tag will automatically hash relevant data using SHA256 before transmitting the event to Facebook."
  },
  {
    "displayName": "Custom Data",
    "name": "customDataGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "name": "customData",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ],
    "help": "For more information on the data parameters you can override, please refer to this \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/conversions-api/parameters/server-event\" target\u003d\"_blank\"\u003edocumentation\u003c/a\u003e."
  }
]


___SANDBOXED_JS_FOR_SERVER___

const JSON = require('JSON');
const Math = require('Math');
const computeEffectiveTldPlusOne = require('computeEffectiveTldPlusOne');
const decodeUriComponent = require('decodeUriComponent');
const encodeUriComponent = require('encodeUriComponent');
const generateRandom = require('generateRandom');
const getAllEventData = require('getAllEventData');
const getCookieValues = require('getCookieValues');
const getRequestHeader = require('getRequestHeader');
const getRequestQueryParameter = require('getRequestQueryParameter');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const makeNumber = require('makeNumber');
const parseUrl = require('parseUrl');
const sendHttpRequest = require('sendHttpRequest');
const sendPixelFromBrowser = require('sendPixelFromBrowser');
const setCookie = require('setCookie');
const sha256Sync = require('sha256Sync');

const eventData = getAllEventData();
const gcsParam = getRequestQueryParameter('gcs') || eventData['x-ga-gcs'];
const consentGranted = (getRequestHeader('gtm-helper-consent-personalized-ads') == 'true' || (gcsParam && gcsParam[2]=='1')|| (getRequestHeader('gtm-helper-gdpr-applies') == 'false' && !gcsParam)) ? true : false;
if (!data.pixelId || !data.accessToken || (!data.sendWithoutConsent && !consentGranted)) {
  data.gtmOnSuccess();
  return;
}

const CAPI_PARTNER_AGENT = 'sgtm-sirdata-2.0.1';
const CAPI_ENDPOINT = 'https://graph.facebook.com/v20.0/' + data.pixelId + '/events?access_token=' + data.accessToken;

const GA4_MAPPINGS = {
  'add_payment_info': 'AddPaymentInfo',
  'add_to_cart': 'AddToCart',
  'add_to_wishlist': 'AddToWishlist',
  'begin_checkout': 'InitiateCheckout',
  'contact': 'Contact',
  'customize_product': 'CustomizeProduct',
  'donate': 'Donate',
  'find_location': 'FindLocation',
  'generate_lead': 'Lead',
  'page_view': 'PageView',
  'purchase': 'Purchase',
  'schedule': 'Schedule',
  'search': 'Search',
  'sign_up': 'CompleteRegistration',
  'start_trial': 'StartTrial',
  'submit_application': 'SubmitApplication',
  'subscribe': 'Subscribe',
  'view_item': 'ViewContent'
};

function getEventName(eventName, data) {
  return data.eventName === 'custom' ? data.customEventName : (GA4_MAPPINGS[eventName] || eventName);
}

function override(data, override) {
  if (override) {
    override.forEach(o => {
      data[o.name] = o.value;
    });
  }
  return data;
}

function isSHA256Hashed(data) {
    return data.match('^[A-Fa-f0-9]{64}$') !== null;
}

function hashData(data){
  if(data && !isSHA256Hashed(data)){
    return sha256Sync(data.toString().trim().toLowerCase(), {outputEncoding: 'hex'});
  }
  return data;
}

function includes(arr, element) {
    for (let i = 0; i < arr.length; i++) {
        if (arr[i] === element) {
            return true;
        }
    }
    return false;
}

function cleanValues(data, hash) {
  //https://developers.facebook.com/docs/marketing-api/conversions-api/parameters/customer-information-parameters
  const keysToHash = ['em', 'ph', 'ge', 'db', 'ln', 'fn', 'ct', 'st', 'zp', 'country'];
  let cleanData = {};
  for (let key in data) {
    if (data[key] && data[key] != 'redacted_for_privacy') {
      if (hash && includes(keysToHash, key)) {
        cleanData[key] = hashData(data[key]);
      } else {
        cleanData[key] = data[key];
      }
    }
  }
  return cleanData;
}

function isValidUUID(uuid) {
  if (uuid.length !== 36 || uuid[8] !== '-' || uuid[13] !== '-' || uuid[18] !== '-' || uuid[23] !== '-') {
    return false;
  }
  const hexChars = '0123456789abcdefABCDEF';
  for (let i = 0; i < uuid.length; i++) {
    if (i !== 8 && i !== 13 && i !== 18 && i !== 23) {
      if (!includes(hexChars, uuid[i])) {
        return false;
      }
    } else if (uuid[i] !== '-') {
      return false;
    }
  }
  return true;
}

function setValidUUID(uuid) {
  if (isValidUUID(uuid)) {
    return uuid;
  }
  return undefined;
}

const url = eventData.page_location || getRequestHeader('referer') || getRequestHeader('gtm-helper-site-origin');
const referrer = eventData.page_referrer;
const originDomain = getRequestHeader('gtm-helper-site-domain') || computeEffectiveTldPlusOne(url);
const subDomainIndex = data.generateFbpCookie && originDomain ? originDomain.split('.').length - 1 : 1;

let fbp = 'fb.' + subDomainIndex + '.' + getTimestampMillis() + '.' + generateRandom(1000000000, 2147483647);
let fbc = '';
if (url) {
  const urlParsed = parseUrl(url);
  if (urlParsed && urlParsed.searchParams.fbclid) {
    fbc = 'fb.' + subDomainIndex + '.' + getTimestampMillis() + '.' + decodeUriComponent(urlParsed.searchParams.fbclid);
  } else {
    const referrerParsed = parseUrl(referrer);
    if (referrerParsed && referrerParsed.searchParams.fbclid) {
      fbc = 'fb.' + subDomainIndex + '.' + getTimestampMillis() + '.' + decodeUriComponent(referrerParsed.searchParams.fbclid);
    }
  }
}

if (consentGranted) {
  let fbpFromCookie = getCookieValues('_fbp')[0];
  if (fbpFromCookie) {
    fbp = fbpFromCookie;
  }

  let fbcFromCookie = getCookieValues('_fbc')[0];
  if (fbcFromCookie && !fbc) {
    fbc = fbcFromCookie;
  }

  if (data.generateFbpCookie) {
    const cookieOptions = {
        domain: '.' + originDomain,
        path: '/',
        samesite: 'Lax',
        secure: true,
        'max-age': 31536000,
        HttpOnly: false
    };
    setCookie('_fbp', fbp, cookieOptions);
    if (fbc) {
      setCookie('_fbc', fbc, cookieOptions);
    }
  }
}

let event = {user_data: {}, custom_data: {}};
event.action_source = eventData.action_source ? eventData.action_source : 'website';
event.event_id = eventData.event_id || 'sirdata_sgtm.' + getTimestampMillis() + '.' + generateRandom(1000000000, 2147483647);
event.event_name = getEventName(eventData.event_name, data);
event.event_source_url = url;
event.event_time = eventData.event_time || Math.round(getTimestampMillis() / 1000);
event.referrer_url = referrer;
event.user_data.fb_login_id = eventData.fb_login_id;
event.user_data.fbc = fbc;
event.user_data.fbp = fbp;

if (data.forwardIdentifiers) {
  // consent for stored User Ids or user-agent or ids
  if (consentGranted) {
    event.user_data.external_id = eventData.user_id || setValidUUID(getRequestHeader('gtm-helper-cookieless-id-domain-specific'));
    event.user_data.client_user_agent = getRequestHeader('gtm-helper-device-user-agent') || eventData.user_agent;
    event.user_data.lead_id = eventData.lead_id;
    event.user_data.subscription_id = eventData.subscription_id;
  }
  event.user_data.client_ip_address = getRequestHeader('gtm-helper-user-ip') || eventData.ip_override;
  event.user_data.country = getRequestHeader('gtm-helper-user-country');
  event.user_data.ct = getRequestHeader('gtm-helper-user-city');
}

if (consentGranted && data.forwardUserData && eventData.user_data) {
  event.user_data.em = eventData.user_data.sha256_email_address || eventData.user_data.email_address || eventData.user_data.email;
  event.user_data.ge = eventData.user_data.gender;
  event.user_data.ph = eventData.user_data.sha256_phone_number || eventData.user_data.phone_number;
  if (eventData.user_data.address && eventData.user_data.address[0]) {
    event.user_data.country = eventData.user_data.address[0].country;
    event.user_data.ct = eventData.user_data.address[0].city;
    event.user_data.fn = eventData.user_data.address[0].sha256_first_name || eventData.user_data.address[0].first_name;
    event.user_data.ln = eventData.user_data.address[0].sha256_last_name || eventData.user_data.address[0].last_name;
    event.user_data.st = eventData.user_data.address[0].region;
    event.user_data.zp = eventData.user_data.address[0].postal_code;
  }
}

let eventCurrency = eventData.currency || '';
let eventValue = eventData.value || 0;
if (consentGranted) {
  event.custom_data.order_id = eventData.transaction_id;
}
event.custom_data.search_string = eventData.search_term;
if (event.event_name === 'InitiateCheckout') {
  event.custom_data.num_items = eventData.items ? eventData.items.length : 0;
}
if (eventData.items && eventData.items.length > 0) {
  event.custom_data.content_type = 'product';
  if (eventData.items[0].item_category) {
    event.custom_data.content_category = eventData.items[0].item_category;
  }

  let contents = [];
  let contentIds = [];
  for (let i = 0; i < eventData.items.length; i++) {
    if (eventData.items[i]) {
      contents.push({id: eventData.items[i].item_id||'',item_price: makeNumber(eventData.items[i].price||0),quantity: makeNumber(eventData.items[i].quantity||0)});
      contentIds.push(eventData.items[i].item_id||'');
      if (!eventValue && eventData.items[i].item_value) {
        eventValue += makeNumber(eventData.items[i].price||0) * makeNumber(eventData.items[i].quantity||0);
      }
    }
  }
  if (contents && contents.length > 0) {
    event.custom_data.contents = contents;
  }
  if (contentIds && contentIds.length > 0) {
    event.custom_data.content_ids = contentIds;
  }

  if (!eventCurrency && eventData.items[0].currency) {
    eventCurrency = eventData.items[0].currency;
  }
  if (eventData.items[0].item_name) {
    event.custom_data.content_name = eventData.items[0].item_name;
  }
}
if (eventCurrency) {
  event.custom_data.currency = eventCurrency;
}
if (eventValue) {
  event.custom_data.value = eventValue;
}
//patch if clear email and no hashed email
if (data.userData && data.userData.email && !data.userData.em) {
  data.userData.em = data.userData.email;
}
event = cleanValues(override(event, data.serverEvent), false);
event.custom_data = cleanValues(override(event.custom_data, data.customData), false);
event.user_data = cleanValues(override(event.user_data, data.userData), true);

const eventRequest = {data: [event], partner_agent: CAPI_PARTNER_AGENT};
const testCode = eventData.test_event_code || data.testId;
if (testCode) {
  eventRequest.test_event_code = testCode;
}

sendHttpRequest(CAPI_ENDPOINT, (statusCode, headers, body) => {
  if (statusCode >= 200 && statusCode < 300) {
    if (consentGranted && data.sendPixelFromBrowser) {
      let url = 'https://www.facebook.com/tr/?ev='+ encodeUriComponent(event.event_name) + '&id=' + encodeUriComponent(data.pixelId.toString());
      if (event.event_id) {
        url += '&eid=' + encodeUriComponent(event.event_id);
      }
      if (fbp) {
        url += '&fbp=' + encodeUriComponent(fbp);
      }
      if (fbc) {
        url += '&fbc=' + encodeUriComponent(fbc);
      }
      const userParams = ['em', 'ph', 'ge', 'db', 'ln', 'fn', 'ct', 'st', 'zp', 'country', 'external_id'];
      for (let i = 0; i < userParams.length; i++) {
          if (userParams[i] && event.user_data[userParams[i]]) {
              url += '&ud[' + userParams[i] + ']=' + encodeUriComponent(event.user_data[userParams[i]].toString());
          }
      }
      url += '&ud[client_ip_address]=' + encodeUriComponent(event.user_data.client_ip_address);
      const customParams = ['content_category', 'content_type', 'content_name', 'contents', 'currency', 'search_string', 'value'];
      for (let i = 0; i < customParams.length; i++) {
          if (customParams[i] && event.custom_data[customParams[i]]) {
              url += '&cd[' + customParams[i] + ']=' + encodeUriComponent(event.custom_data[customParams[i]].toString());
          }
      }
      if (event.custom_data.content_ids) {
        url += '&cd[content_ids]=' + encodeUriComponent(JSON.stringify(event.custom_data.content_ids));
      }
      if (event.custom_data.contents) {
        url += '&cd[contents]=' + encodeUriComponent(JSON.stringify(event.custom_data.contents));
      }
      sendPixelFromBrowser(url);
    }
    data.gtmOnSuccess();
  } else {
    data.gtmOnFailure();
  }
}, {headers: {'content-type': 'application/json'}, method: 'POST'}, JSON.stringify(eventRequest));


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbc"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbp"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://graph.facebook.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_fbc"
              },
              {
                "type": 1,
                "string": "_fbp"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtm-helper-consent-personalized-ads"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtm-helper-user-country"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtm-helper-user-city"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtm-helper-device-user-agent"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtm-helper-user-ip"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtm-helper-site-origin"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtm-helper-site-domain"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtm-helper-gdpr-applies"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtm-helper-cookieless-id-domain-specific"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "queryParametersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "remoteAddressAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "queryParameter"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gcs"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel_from_browser",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://www.facebook.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Check generic errors
  code: |-
    const mockData = {
      // Mocked field values
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: ''


___NOTES___

Created on 21/11/2022, 20:30:02
